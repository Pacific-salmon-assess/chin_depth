### ROMS Data Clean
## Export stations for query, then import and evaluate 
## Query conducted by Doug Jackson (doug@qedaconsulting.com)
## Feb 14, 2022

library(tidyverse)


# moderately cleaned detections data (includes depth/temperature sensors)
depth_raw <- readRDS(here::here("data", "detections_all.RDS")) %>%
  filter(!is.na(depth),
         depth > 0)


## EXPORT STATIONS -------------------------------------------------------------

# calculate sample size for ROMS pull assuming hourly bins for each receiver and
# either continuous (first to last detection) or gappy coverage

depth_dets1 <- depth_raw %>% 
  mutate(
    hour = lubridate::hour(date_time) + 1,
    day = lubridate::day(date_time),
    month = lubridate::month(date_time),
    year = lubridate::year(date_time)
  ) 


# infill to make continuous for each receiver based on first/last detection
# currently unused
# depth_dat_infill <- split(depth_dets1, depth_dets1$receiver) %>% 
#   purrr::map(., function (x) {
#     min_day <- format(round(min(x$date_time), units = "hours"))
#     max_day <- format(round(max(x$date_time) + 3600, units = "hours"))
#     time_seq <- seq.POSIXt(as.POSIXct(min_day), as.POSIXct(max_day), 
#                            by = "1 hour")
#     data.frame(
#       date_time = time_seq,
#       receiver = unique(x$receiver),
#       latitude = unique(x$latitude),
#       longitude = unique(x$longitude)
#     ) %>% 
#       mutate(
#         hour = lubridate::hour(date_time) + 1,
#         day = lubridate::day(date_time),
#         month = lubridate::month(date_time),
#         year = lubridate::year(date_time)
#       ) 
#   }) %>% 
#   bind_rows()


# expand depth dets by different covariates and depths
trim_dets <- depth_dets1 %>% 
  select(year, month, day, hour, lat = latitude, lon = longitude) %>% 
  distinct()
var_list <- c("u", "v", "w", "zooplankton", "rho")
depth_list <- c(5, 25, 50)

roms_dat <- expand.grid(
  variable = var_list,
  depth = depth_list
) %>% 
  mutate(
    # depth = ifelse(variable == "w", -999, depth),
    fac = paste(variable, depth, sep = "_")
  ) %>% 
  distinct() %>% 
  split(., .$fac) %>% 
  purrr::map(., function (x) {
    trim_dets %>% 
      mutate(variable = x$variable,
             depth = x$depth)
  }) %>% 
  bind_rows %>% 
  mutate(depthFrac = -999) %>% 
  dplyr::select(year, month, day, hour, variable, lat,
                lon, depth, depthFrac) 


# export 
write.csv(roms_dat, here::here("data", "stations_roms_no_infill.csv"),
          row.names = FALSE)


## IMPORT ROMS PULL ------------------------------------------------------------

# query generated by Doug; note some stations have missing values due to outside
# survey domain

roms_dat <- read.csv(
  here::here("data", "stations_roms_no_infill_10Feb22_all.csv"))

# evaluate correlations between depth strata for each variable
wide_roms <- roms_dat %>% 
  filter(!value == "-999") %>% 
  distinct() %>% 
  pivot_wider(names_from = "depth", names_prefix = "depth_",
              values_from = "value") %>% 
  glimpse()

# co
corr <- cor(depth$train[[1]] %>%  dplyr::select(hour:shore_dist))
ggcorrplot::ggcorrplot(corr)


