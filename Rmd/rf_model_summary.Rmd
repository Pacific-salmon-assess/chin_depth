---
title: "rf_model_summary"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(plyr)
library(tidyverse)
library(caret)
library(recipes)
library(DALEX)
library(DALEXtra)
library(ranger)

depth_dat_raw <- readRDS(
  here::here("data", "depth_dat_nobin.RDS")) %>% 
  mutate(stage = as.factor(stage),
         depth = -1 * pos_depth)
```

## Background

Sensor data from V13P tags provide an opportunity to identify environmental variables that regulate Chinook salmon depth distributions. Intuitively depth distributions could be shaped by a range of physiological (condition, maturity stage), spatial (bathymetry, distance from shore, lat/long), temporal (diurnal and seasonal cycles), and dynamic environmental variables (temperature, salinity, prey availability). Importantly many of these covariates can interact with each other in counterintuitive ways.

Indeed the raw data show some relationships with each of these processes. As an example, there is (unsurprisingly) a relationship between bottom bathymetry and depth, which appears to vary among regions.

```{r raw_bathy, echo=FALSE}
ggplot(depth_dat_raw) +
  geom_point(aes(x = mean_bathy, y = depth, fill = region_f), 
             alpha = 0.4, shape = 21) +
  facet_wrap(~stage)
```

There is also a strong seasonal and spatial signal in depth distribution.

```{r raw_season, echo=FALSE}
ggplot(depth_dat_raw) +
  geom_point(aes(x = det_day, y = depth, fill = region_f), 
             alpha = 0.4, shape = 21) +
  facet_wrap(~stage)
```

## Modeling Approach

The downside of high resolution individual data and a large number of covariates is that complex models are often necessary to account for structure within the data. In this case, because there are a large number of repeated measurements from a single individual there is substantial temporal autocorrelation. Accounting for this autocorrelation is particularly difficult because sometimes the lag is minutes and sometimes it's weeks. The response, depth, is also not normally distributed (bounded by the surface and bottom bathymetry). Typically these issues are addressed with a combination of link functions appropriate for non-normal data, transforming the response (e.g. quantifying differences using binned or proportional depth) or binning (e.g. taking the mean within an hour interval), however there are downsides to these approaches. Additionally a spatially explicit model is preferred to account for spatial autocorrelation and to estimate how Chinook may be behaving in locations within the study area, but without receivers.

Since my initial attempts to fit GLMs and GAMs in various frameworks were not successful, Sean suggested using machine learning techniques which have fewer distributional assumptions and are robust to interactions among covariates, as well as autocorrelation. Some preliminary analyses indicated a random forest model fit to untransformed depth data was better supported than models based on transformed data. 

Briefly random forests generate a series of regression trees and average their predictions. Each tree begins with all the observations and partitions the data by splitting along a single covariate, choosing the covariate and node that minimizes the sums of squares at each each node. To increase stability, correlations among trees are reduced by using a bootstrap sample of the original data for each tree and at each split, randomly selecting a subset of covariates. The major downside of these models is their interpretability, but given the nature of our data I think they're the best option. 

I've included the following covariates, but am open to others if you feel I'm missing something.

* Life stage--mature (fish will spawn that year) vs. immature (fish remains at sea)
* Hour--diurnal cycles
* Year day--seasonal cycles
* Bottom depth--mean within an 800 meter radius of the receiver (approximate detection range)
* Bathymetric slope--mean as above
* Distance to shore
* UTM coordinates--spatial variation that is not accounted for by bathymetric variables or distance to shore
* u-momentum--proxy for horizontal current strength (ROMS output)
* v-momentum--proxy for horizontal current strength (ROMS)
* w-momentum--proxy for vertical current strength (ROMS)
* Temperature (ROMS)

The ROMS derived variables are outputs assuming 25 m depth at the location of the receiver. I chose 25 m because this was the approximate "average" depth in the Chinook observations and because most variables were correlated at 5, 25, and 75 m depths, but we may want to use sea surface temperature instead.


```{r import_model_fits, echo=FALSE}
## issues with explainer and fit list; use random forest model from 
# depth_caret.R instead
# fits <- readRDS(here::here("data", "model_fits", "depth_rf_nobin_list.rds"))
rf_mod <- readRDS(here::here("data", "model_fits", "depth_rf_nobin.rds"))
```


Generally random forest models are evaluated relative to testing data, which are not used to fit the models. For simplicity's sake I'm showing performance relative to the training data. Ultimately the plan is to use the upcoming year's detections as our out-of-sample testing dataset to evaluate model performance.

```{r rf_preds, echo=FALSE}
rf_mod_final <- rf_mod$finalModel
train_dat <- rf_mod$trainingData 
train_dat$pred_depth <- rf_mod_final$predictions
# bake_train_dat <- prep(fits[[3]]$recipe) %>%
#   bake(.,
#        new_data = train_dat %>%
#          dplyr::select(-depth))

# preds <- predict(rf_mod, data = bake_train_dat)$predictions

plot(pred_depth ~ depth, data = train_dat, col = alpha("black", 0.3), pch=21)
abline(0, 1, col = "red")
```

Residuals are reasonably distributed, but do show a relationship with depth. However I don't think this is an issue given the modeling framework.

```{r rf_resids, echo = FALSE}
train_dat$resids <- train_dat$depth - train_dat$pred_depth
hist(train_dat$resids, breaks = 50)
plot(resids ~ mean_bathy, data = train_dat, col = alpha("black", 0.3), pch=21)
```

```{r gen_rf_explainer, include=FALSE}
# explainers are slow to compute so import from depth_caret_rf.R
exp_list <- readRDS(here::here(
  "data", "model_fits", "depth_rf_nobin_explainers.rds"
))
        
```

The following figure estimates each covariate's relative importance by permutation (a single covariate is permuted, breaking its relationship with depth, and the change in RMSE is calculated). More important variables will result in a greater increase in RMSE after permutation and the whiskers represent variation among different permutations. Here bathymetry and life stage (mature v. immature) have the greatest explanatory power, but seasonal (det_day) and diurnal (hour) effects are also present. The remaining spatial and ROMS variables have more modest influence on mean depth.

```{r variable_importance, include=FALSE}
exp_list$var_imp_plot
```

Partial dependence profiles provide an estimate of how the response changes across different values of a covariate, holding all other covariates at a specific value (here there mean). Seasonal and bathymetry effects are particularly pronounced. Generally immature fish have deeper distributions than mature fish, but there is evidence for interactive effects (e.g. bathymetry has a stronger effect for immature than mature fish). 

```{r profile_plots, include=FALSE}
plot(exp_list$pdp)
```

While the partial dependence profiles provide information on how individual covariates influence mean depth, many of the variables are spatial and naturally interact with one another (e.g. a location will have a single value for bathymetric depth, slope, UTM coordinates, and shore distance). We can use a grid with each of these values to visualize how predicted depth varies across space while holding temporally dynamic variables at reference values.


```{r spatial_preds, include=FALSE}
coast <- readRDS(here::here("data", "crop_coast_sf.RDS")) 

bath_grid <- readRDS(here::here("data", "pred_bathy_grid.RDS")) %>%
  filter(!is.na(slope), 
         depth < 400) %>% 
  dplyr::rename(mean_bathy = depth, mean_slope = slope)

# calculate mean roms_variables for different seasons (using monthly averages)
roms_month_means <- readRDS(here::here("data", "depth_dat_nobin.RDS")) %>% 
  mutate(month = lubridate::month(date_time)) %>% 
  filter(month %in% c(1, 4, 7, 10)) %>% 
  mutate(month = as.factor(as.character(month))) %>% 
  group_by(month) %>% 
  dplyr::summarize(
    u = mean(u, na.rm = T),
    roms_temp = mean(roms_temp, na.rm = T),
    v = mean(v, na.rm = T),
    w = mean(w, na.rm = T)
  ) 

# stratify predictions by non-spatial covariates
dat_tbl <- expand_grid(
  hour = c(0.5, 12.5),
  # jan 1, apr 1, jul 1, oct 1
  det_day = c(1, 91, 182, 274),
  stage = unique(depth_dat_raw$stage)
) %>% 
  mutate(
    day = fct_recode(as.factor(hour), "day" = "0.5", "night" = "12.5"),
    season = fct_recode(as.factor(det_day), "winter" = "1", "spring" = "91",
                        "summer" = "182", "fall" = "274"),
    month = factor(as.factor(det_day), labels = c("1", "4", "7", "10")),
    # create prediction grid based on fixed covariates
    pred_grid = purrr::pmap(
      list(month, hour, det_day, stage),
      function (w, x, y, z) {
        bath_grid %>%
          mutate(
            month = w,
            hour = x,
            det_day = y,
            stage = z) %>%
          left_join(., roms_month_means, by = "month")
      }
    ),
    # generate predictions
    preds = purrr::map(pred_grid, function (x) {
      bath_grid %>%
        mutate(
          pred = predict(rf_mod, newdata = x)
        )
    }
    )
  ) 


dat <- dat_tbl %>% 
  select(stage, day, season, preds) %>% 
  unnest(cols = preds) 
```

Each map is constrained to the core study area (i.e. continental shelf and southern areas with majority of receiver coverage). Warmer colors always represent deeper depths, but the scale is relative and varies from figure to figure. 

First are seasonal patterns. These are focused only on immature fish, since winter observations are unavailable for mature fish, and are daytime predictions. Note that maximum depth increases slightly in winter, but the major change seems to more widespread deep observations in winter months.

```{r seasonal_patterns, echo=FALSE}
ggplot() + 
  geom_sf(data = coast) +
  geom_raster(data = dat %>% filter(stage == "immature", day == "day",
                                    season %in% c("winter", "summer")), 
              aes(x = longitude, y = latitude, fill = pred)) +
  scale_fill_viridis_c() +
  ggsidekick::theme_sleek() +
  facet_wrap(~season)
```

Immature fish have deeper distributions during summer/daylight and are responding more strongly to bathymetric features than mature fish. 

```{r maturity_patterns, echo=FALSE}
ggplot() + 
  geom_sf(data = coast) +
  geom_raster(data = dat %>% filter(season == "summer", day == "day"), 
              aes(x = longitude, y = latitude, fill = pred)) +
  scale_fill_viridis_c() +
  ggsidekick::theme_sleek() +
  facet_wrap(~stage)
```

Counterintuitively, there is evidence for slightly deeper distributions at night. Note that because there's a spatial component, it may be more appropriate to visualize the difference between day/night predictions in a given location.  

```{r dirunal_patterns, echo=FALSE}
day_night_diff <- dat %>% 
  pivot_wider(names_from = day, values_from = pred) %>% 
  mutate(diurnal_diff = day - night)

ggplot() + 
  geom_sf(data = coast) +
  geom_raster(data = dat %>% filter(season %in% c("summer"),
                                    stage == "mature"), 
              aes(x = longitude, y = latitude, fill = pred)) +
  scale_fill_viridis_c() +
  ggsidekick::theme_sleek() +
  facet_wrap(~day)
```

While I think these figures characterize the main take homes from the depth data, this analysis is still preliminary. In particular, I need to generate estimates of uncertainty for the partial dependency profiles via bootstrapping. As previously mentioned I'd also like to use 2022 detections as an out-of-sample test for the model to evaluate its performance with new data. If folks have any suggestions on how it should be tweaked (e.g. alternative covariates), please let me know.  